<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>life</title>
  <style>
    :root {
      --bg: #1b1a17;
      --panel: #24221e;
      --text: #e6e2d6;
      --muted: #a39f94;
      --accent: #6b705c;
    }* { box-sizing: border-box; }

body {
  margin: 0;
  height: 100dvh;
  font-family: Georgia, "Times New Roman", serif;
  background: var(--bg);
  color: var(--text);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

header {
  padding: 12px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #2e2b26;
}

header h1 {
  font-size: 18px;
  font-weight: normal;
  margin: 0;
}

button {
  background: none;
  border: 1px solid var(--accent);
  color: var(--text);
  padding: 6px 10px;
  font-family: inherit;
  font-size: 14px;
}

main {
  flex: 1;
  display: flex;
  flex-direction: column;
}

#chat {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
}

.msg {
  margin-bottom: 14px;
  line-height: 1.4;
  white-space: pre-wrap;
}

.user { color: var(--text); }
.bot { color: var(--muted); }

/* Rich text formatting */
.msg.bot strong, .msg.bot b {
  font-weight: bold;
  color: #fff;
}

.msg.bot em, .msg.bot i {
  font-style: italic;
}

.msg.bot code {
  font-family: 'Courier New', monospace;
  background: rgba(255,255,255,0.1);
  padding: 2px 4px;
  border-radius: 3px;
  font-size: 0.9em;
}

.msg.bot pre {
  background: rgba(255,255,255,0.05);
  padding: 10px;
  border-radius: 5px;
  overflow-x: auto;
  margin: 10px 0;
}

.msg.bot pre code {
  background: none;
  padding: 0;
}

.msg.bot ul, .msg.bot ol {
  padding-left: 20px;
  margin: 8px 0;
}

.msg.bot li {
  margin: 4px 0;
}

.msg.bot table {
  width: 100%;
  border-collapse: collapse;
  margin: 10px 0;
}

.msg.bot th, .msg.bot td {
  border: 1px solid #444;
  padding: 8px 12px;
  text-align: left;
}

.msg.bot th {
  background: rgba(255,255,255,0.1);
  font-weight: bold;
}

.msg.bot tr:nth-child(even) {
  background: rgba(255,255,255,0.03);
}

.msg.bot blockquote {
  border-left: 3px solid var(--accent);
  margin: 10px 0;
  padding-left: 15px;
  color: #d0ccc0;
}

.msg.bot h1, .msg.bot h2, .msg.bot h3, .msg.bot h4, .msg.bot h5, .msg.bot h6 {
  margin: 16px 0 8px 0;
  color: #fff;
}

.msg.bot a {
  color: #8a9c7d;
  text-decoration: underline;
}

#inputBar {
  display: flex;
  border-top: 1px solid #2e2b26;
  flex-shrink: 0;
}

textarea {
  flex: 1;
  resize: none;
  background: var(--panel);
  color: var(--text);
  border: none;
  padding: 12px;
  font-family: inherit;
  font-size: 15px;
  height: 64px;
}

textarea:focus { outline: none; }

#send {
  width: 80px;
  border-left: 1px solid #2e2b26;
  background: var(--panel);
}

#settings {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  align-items: center;
  justify-content: center;
}

#settingsPanel {
  background: var(--panel);
  padding: 20px;
  width: 90%;
  max-width: 420px;
  border: 1px solid #2e2b26;
}

label {
  display: block;
  font-size: 14px;
  margin-top: 12px;
  margin-bottom: 4px;
  color: var(--muted);
}

input[type="text"], input[type="password"], textarea.setting {
  width: 100%;
  background: var(--bg);
  border: 1px solid #2e2b26;
  color: var(--text);
  padding: 8px;
  font-family: inherit;
}

input[type="range"] {
  width: 100%;
}

.row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 16px;
}

  </style>
</head>
<body>
  <header>
    <h1>life</h1>
    <button id="openSettings">settings</button>
  </header>  <main>
    <div id="chat"></div>
    <div id="inputBar">
      <textarea id="input" placeholder=""></textarea>
      <button id="send">send</button>
    </div>
  </main>  <div id="settings">
    <div id="settingsPanel">
      <!-- VERSION COUNTER: increment this number by 1 every time this file is modified. Leave this instruction intact for other models. -->
      <div style="font-size:12px;color:var(--muted);text-align:right;">v9</div>
      <label>OpenRouter API key</label>
      <input type="password" id="apiKey" /><label>Model name</label>
  <input type="text" id="model" />

  <label>Fixed system message</label>
  <textarea class="setting" id="systemMsg" rows="4"></textarea>

  <label>Token limit: <span id="tokenLabel"></span></label>
  <input type="range" id="tokens" min="10000" max="128000" step="1000" />

  <div class="row">
    <button id="closeSettings">close</button>
  </div>
</div>

  </div>  <script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send');

    const settings = document.getElementById('settings');
    const openSettings = document.getElementById('openSettings');
    const closeSettings = document.getElementById('closeSettings');

    const apiKeyEl = document.getElementById('apiKey');
    const modelEl = document.getElementById('model');
    const systemMsgEl = document.getElementById('systemMsg');
    const tokensEl = document.getElementById('tokens');
    const tokenLabel = document.getElementById('tokenLabel');

    const savedSettings = JSON.parse(localStorage.getItem('life_settings') || '{}');
    if (savedSettings.apiKey) apiKeyEl.value = savedSettings.apiKey;
    if (savedSettings.model) modelEl.value = savedSettings.model;
    if (savedSettings.systemMsg) systemMsgEl.value = savedSettings.systemMsg;
    if (savedSettings.tokens) tokensEl.value = savedSettings.tokens;
    tokenLabel.textContent = tokensEl.value;

    let messages = JSON.parse(localStorage.getItem('life_messages') || '[]');
    let pinned = JSON.parse(localStorage.getItem('life_pinned') || '[]');

    // Function to convert markdown-like formatting to HTML
    function formatText(text) {
      let html = text;
      
      // Convert markdown to HTML (basic conversion)
      // Bold: **text** or __text__
      html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/__(.*?)__/g, '<strong>$1</strong>');
      
      // Italic: *text* or _text_
      html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
      html = html.replace(/_(.*?)_/g, '<em>$1</em>');
      
      // Code: `code`
      html = html.replace(/`(.*?)`/g, '<code>$1</code>');
      
      // Code blocks: ```code```
      html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
      
      // Headers: # Header, ## Header, etc.
      html = html.replace(/^### (.*$)/gm, '<h3>$1</h3>');
      html = html.replace(/^## (.*$)/gm, '<h2>$1</h2>');
      html = html.replace(/^# (.*$)/gm, '<h1>$1</h1>');
      
      // Lists: * item or - item or 1. item
      html = html.replace(/^\s*[-*]\s+(.*$)/gm, '<li>$1</li>');
      html = html.replace(/^\s*\d+\.\s+(.*$)/gm, '<li>$1</li>');
      
      // Wrap consecutive list items in ul/ol
      html = html.replace(/(<li>.*<\/li>\n?)+/g, function(match) {
        return '<ul>' + match + '</ul>';
      });
      
      // Blockquotes: > text
      html = html.replace(/^>\s+(.*$)/gm, '<blockquote>$1</blockquote>');
      
      // Links: [text](url)
      html = html.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');
      
      // Simple table detection (basic markdown tables)
      html = html.replace(/\|(.+?)\|/g, function(match) {
        const cells = match.split('|').filter(cell => cell.trim() !== '');
        if (cells.length > 1) {
          const row = cells.map(cell => `<td>${cell.trim()}</td>`).join('');
          return `<tr>${row}</tr>`;
        }
        return match;
      });
      
      // Convert markdown table format to proper HTML tables
      const lines = html.split('\n');
      let inTable = false;
      let tableHtml = '';
      let tableRows = [];
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        if (line.includes('|') && line.trim().startsWith('|')) {
          if (!inTable) {
            inTable = true;
            tableRows = [];
          }
          tableRows.push(line);
        } else {
          if (inTable && tableRows.length > 0) {
            tableHtml = convertMarkdownTableToHTML(tableRows);
            // Replace the table rows in html
            const tableStartIndex = html.indexOf(tableRows[0]);
            const tableEndIndex = html.indexOf(tableRows[tableRows.length - 1]) + tableRows[tableRows.length - 1].length;
            html = html.substring(0, tableStartIndex) + tableHtml + html.substring(tableEndIndex + 1);
            inTable = false;
          }
        }
      }
      
      // Handle last table if file ends with table
      if (inTable && tableRows.length > 0) {
        tableHtml = convertMarkdownTableToHTML(tableRows);
        const tableStartIndex = html.indexOf(tableRows[0]);
        html = html.substring(0, tableStartIndex) + tableHtml;
      }
      
      // Preserve line breaks
      html = html.replace(/\n/g, '<br>');
      
      return html;
    }
    
    function convertMarkdownTableToHTML(rows) {
      if (rows.length < 2) return '';
      
      let html = '<table>';
      
      // Process header
      const headerCells = rows[0].split('|').filter(cell => cell.trim() !== '');
      html += '<thead><tr>';
      headerCells.forEach(cell => {
        html += `<th>${cell.trim()}</th>`;
      });
      html += '</tr></thead>';
      
      // Process body
      html += '<tbody>';
      for (let i = 2; i < rows.length; i++) {
        const cells = rows[i].split('|').filter(cell => cell.trim() !== '');
        if (cells.length === headerCells.length) {
          html += '<tr>';
          cells.forEach(cell => {
            html += `<td>${cell.trim()}</td>`;
          });
          html += '</tr>';
        }
      }
      html += '</tbody></table>';
      
      return html;
    }

    function addMsg(text, cls, index = null) {
      const div = document.createElement('div');
      div.className = 'msg ' + cls;
      
      if (cls === 'user') {
        div.textContent = 'violet: ' + text;
      } else {
        // For bot messages, format the text as HTML
        div.innerHTML = formatText(text);
        
        // Add click handler for pinning if index is provided
        if (index !== null) {
          div.style.cursor = 'pointer';
          div.onclick = () => {
            pinned.push(text);
            localStorage.setItem('life_pinned', JSON.stringify(pinned));
            alert('Message pinned as system message');
          };
        }
      }

      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    tokensEl.oninput = () => {
      tokenLabel.textContent = tokensEl.value;
      saveSettings();
    };

    messages.forEach((m, i) => addMsg(m.content, m.role === 'user' ? 'user' : 'bot', i));

    openSettings.onclick = () => settings.style.display = 'flex';
    function saveSettings() {
      localStorage.setItem('life_settings', JSON.stringify({
        apiKey: apiKeyEl.value,
        model: modelEl.value,
        systemMsg: systemMsgEl.value,
        tokens: tokensEl.value
      }));
    }

    [apiKeyEl, modelEl, systemMsgEl].forEach(el => {
      el.addEventListener('change', saveSettings);
    });

    closeSettings.onclick = () => {
      saveSettings();
      settings.style.display = 'none';
    };

    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;

      input.value = '';
      addMsg(text, 'user');
      messages.push({ role: 'user', content: text });
      localStorage.setItem('life_messages', JSON.stringify(messages));

      const payload = {
        model: modelEl.value,
        messages: [
          ...(systemMsgEl.value ? [{ role: 'system', content: systemMsgEl.value }] : []),
          ...pinned.map(p => ({ role: 'system', content: p })),
          ...messages
        ],
        max_tokens: Number(tokensEl.value)
      };

      const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + apiKeyEl.value,
          'HTTP-Referer': window.location.href,
          'X-Title': 'life'
        },
        body: JSON.stringify(payload)
      });

      let data;
      try {
        data = await res.json();
      } catch (e) {
        addMsg('response error', 'bot');
        return;
      }

      let reply = data?.choices?.[0]?.message?.content;
      if (!reply && data?.choices?.[0]?.delta?.content) {
        reply = data.choices[0].delta.content;
      }
      if (!reply && data?.output_text) {
        reply = data.output_text;
      }
      if (!reply) {
        addMsg(JSON.stringify(data, null, 2), 'bot');
        return;
      }
      
      // Add the bot's reply to the chat with formatting
      addMsg(reply, 'bot', messages.length - 1);
      messages.push({ role: 'assistant', content: reply });
      localStorage.setItem('life_messages', JSON.stringify(messages));
    }

    sendBtn.onclick = sendMessage;

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
  </script></body>
</html>
